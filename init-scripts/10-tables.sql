create table author (
  author_id int primary key generated by default as identity,
  aname varchar(64) not null,
  biography text
);

create table library (
  library_id int primary key generated by default as identity,
  loc varchar(16),
  library_name varchar(32) not null
);

create table book (
  book_id int generated by default as identity,
  author_id int,
  pdate date,
  synopsis text,
  title varchar(64) not null,
  primary key (book_id, author_id),
  foreign key (author_id) references author (author_id)
);

create table genre (
  book_id int,
  author_id int,
  label varchar(16),
  primary key (book_id, author_id, label),
  foreign key (book_id, author_id) references book (book_id, author_id)
);

create table library_contains (
  library_id int,
  book_id int,
  author_id int,
  no_of_copies int default 0,
  primary key (library_id, book_id, author_id),
  foreign key (library_id) references library (library_id) on update cascade,
  foreign key (book_id, author_id) references book (book_id, author_id) on update cascade
);

create table users (
  user_id int primary key generated by default as identity,
  uname varchar(64) not null unique,
  address varchar(32),
  -- TODO: Validate in update constraint(?)
  -- See https://en.wikipedia.org/wiki/E.164
  phone_no varchar(15)
);

create table admin (
  super_id int primary key,
  foreign key (super_id) references users (user_id) on delete cascade
);

create table head_librarian (
  super_id int primary key,
  appointer int not null,
  foreign key (super_id) references users (user_id) on delete cascade,
  foreign key (appointer) references admin (super_id)
);

create table librarian (
  librarian_id int primary key,
  manager_id int not null,
  library_id int not null,
  foreign key (librarian_id) references users (user_id) on delete cascade,
  foreign key (manager_id) references head_librarian (super_id),
  foreign key (library_id) references library (library_id)
);

create table loan (
  loan_id int generated by default as identity,
  user_id int,
  ret_date timestamp with time zone not null,
  start_date timestamp with time zone not null,
  librarian_id int,
  primary key (loan_id, user_id),
  foreign key (user_id) references users (user_id) on delete cascade,
  foreign key (librarian_id) references librarian (librarian_id) on delete set null
);

create table authentication (
  user_id int primary key,
  username varchar(16) not null unique,
  -- TODO: Decide how encoded as database
  pass varchar(255) not null,
  foreign key (user_id) references users (user_id) on delete cascade
);

create table loan_request (
  loan_id int not null,
  user_id int not null,
  book_id int not null,
  author_id int not null,
  foreign key (loan_id, user_id) references loan (loan_id, user_id) on delete cascade,
  foreign key (book_id, author_id) references book (book_id, author_id),
  primary key (loan_id, user_id, book_id, author_id)
);

create table loan_book (
  loan_id int not null,
  user_id int not null,
  book_id int not null,
  author_id int not null,
  foreign key (loan_id, user_id) references loan (loan_id, user_id) on delete cascade,
  foreign key (book_id, author_id) references book (book_id, author_id),
  primary key (loan_id, user_id, book_id, author_id)
);

create table review (
  review_id int generated by default as identity,
  user_id int,
  rating int not null check (rating > 0 and rating < 6),
  body text,
  book_id int not null,
  author_id int not null,
  primary key (review_id, user_id),
  foreign key (user_id) references users (user_id) on delete cascade,
  foreign key (book_id, author_id) references book (book_id, author_id)
);

-- 1. author table
INSERT INTO author (aname, biography) VALUES
('J.K. Rowling', 'British author, best known for the Harry Potter series.'),
('George Orwell', 'English novelist and essayist, famous for books like 1984 and Animal Farm.'),
('J.R.R. Tolkien', 'English writer and academic, best known for The Hobbit and The Lord of the Rings.');

-- 2. library table
INSERT INTO library (loc, library_name) VALUES
('New York', 'Central Library'),
('London', 'City Library'),
('Los Angeles', 'LA Public Library');

-- 3. book table
INSERT INTO book (author_id, pdate, synopsis, title) VALUES
(1, '1997-06-26', 'A young boy discovers he is a wizard and attends Hogwarts School of Witchcraft and Wizardry.', 'Harry Potter and the Philosopher''s Stone'),
(2, '1945-08-17', 'A dystopian novel about a totalitarian regime that uses surveillance and mind control to dominate society.', '1984'),
(3, '1954-07-29', 'An epic fantasy story about a young hobbit who embarks on a journey to destroy a powerful ring.', 'The Fellowship of the Ring');

-- 4. genre table
INSERT INTO genre (book_id, author_id, label) VALUES
(1, 1, 'Fantasy'),
(2, 2, 'Dystopian'),
(3, 3, 'Fantasy');

-- 5. library_contains table
INSERT INTO library_contains (library_id, book_id, author_id, no_of_copies) VALUES
(1, 1, 1, 10),
(2, 2, 2, 5),
(3, 3, 3, 7);

-- 6. users table
INSERT INTO users (uname, address, phone_no) VALUES
('john_doe', '123 Main St, New York', '+1234567890'),
('alice_smith', '456 Oak St, London', '+1987654321'),
('bob_jones', '789 Pine St, Los Angeles', '+1122334455');

-- 7. admin table
INSERT INTO admin (super_id) VALUES
(1),
(2);

-- 8. head_librarian table
INSERT INTO head_librarian (super_id, appointer) VALUES
(1, 1),
(2, 1);

-- 9. librarian table
INSERT INTO librarian (librarian_id, manager_id, library_id) VALUES
(1, 1, 1),
(2, 2, 2);

-- 10. loan table
INSERT INTO loan (user_id, ret_date, start_date, librarian_id) VALUES
(1, '2025-04-20 10:00:00+00', '2025-04-10 10:00:00+00', 1),
(2, '2025-04-22 10:00:00+00', '2025-04-11 10:00:00+00', 2);

-- 11. authentication table
INSERT INTO authentication (user_id, username, pass) VALUES
(1, 'john_doe', 'hashed_password_123'),
(2, 'alice_smith', 'hashed_password_456'),
(3, 'bob_jones', 'hashed_password_789');

-- 13. loan_book table
INSERT INTO loan_book (loan_id, user_id, book_id, author_id) VALUES
(1, 1, 1, 1),
(2, 2, 2, 2);

-- 14. review table
INSERT INTO review (user_id, rating, body, book_id, author_id) VALUES
(1, 5, 'An amazing book that captivates the reader from the start.', 1, 1),
(2, 4, 'A thought-provoking book that offers much insight into political systems.', 2, 2),
(3, 5, 'An epic fantasy adventure with unforgettable characters and landscapes.', 3, 3);
